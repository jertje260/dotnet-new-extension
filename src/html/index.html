<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading templates</title>
    <style>
    input, label {
        display: block;
    }
    </style>
</head>

<body>
    <p id="loading">Loading templates, please wait</p>

    <div id="templates" style="display: none;">
        <p>Click an item to see more information</p>
        <table id="template-table" style="width: 66%; display: inline-block">
            <thead>
                <tr>
                    <th>
                        Template Name
                    </th>
                    <th>
                        Template Tags
                    </th>
                </tr>
            </thead>
            <tbody id="template-body">
            </tbody>
        </table>
    </div>
    <div id="template" style="display: none;">
        <button id="back-to-templates">Back to templates</button>
        <p id="loading-template">Loading template</p>
        <div id="template-item" style="display: none;">

        </div>
        <div id="template-buttons">
            <button id="dryRun">Dry Run</button>
            <button id="create">Create</button>
        </div>
    </div>
    </div>
</body>
<script>
    const vscode = acquireVsCodeApi();

    function init() {
        initMessageHandling();
        initEventHandling();
        fetchTemplates();
    }

    function initMessageHandling() {
        window.addEventListener('message', event => {

            const message = event.data; // The JSON data our extension sent
            console.log(message);
            switch (message.command) {
                case 'templates': {
                    console.info('loading templates');
                    loadTemplates(message.data);
                    break;
                }
                case 'template': {
                    console.info('load template');
                    loadTemplate(message.data);
                    break;
                }
            }
        });
    }

    function initEventHandling() {
        document.getElementById("template-body").addEventListener("click", (evt) => {
            if (evt.target.parentElement.localName === "tr") {
                fetchTemplate(evt.target.parentElement.id);
            }
        });

        document.getElementById("back-to-templates").addEventListener("click", (evt) => {
            // hide template, show templates
            showTemplatesBlock();
        });
    }

    function fetchTemplates() {
        vscode.postMessage({
            command: 'loadTemplates',
            data: {}
        });
    }

    function showTemplateBlock() {
        document.getElementById("templates").style.display = "none";
        document.getElementById("template").style.display = "block"
    }

    function showTemplatesBlock() {
        document.getElementById("template").style.display = "none";
        document.getElementById("templates").style.display = "block"
    }

    function fetchTemplate(shortName) {
        showTemplateBlock();
        document.getElementById('loading-template').style.display = "block";
        document.getElementById('template-item').style.display = "none";
        vscode.postMessage({
            command: 'loadTemplate',
            data: shortName
        });
    }

    function loadTemplates(templates) {
        const tbody = document.getElementById("template-body");
        let template = "";
        for (let i = 0; i < templates.length; i++) {
            const t = templates[i];
            template += `<tr class="template" id="${t.shortName}"><td>${t.templateName}</td><td>${t.tags.join(' ')}</td></tr>`;
        }
        tbody.innerHTML = template;
        document.getElementById("loading").style.display = "none";
        document.getElementById("templates").style.display = "block";
    }

    function loadTemplate(template) {
        const itemTemplate = document.getElementById('template-item');

        let html = `
        <table>
            <tr>
                <td>
                    Name:
                </td>
                <td>
                    ${template.templateName}
                </td>
            </tr>
            <tr>
                <td>
                    Description:
                </td>
                <td>
                    ${template.description}
                </td>
            </tr>
        </table>`;

        html += generateForm(template);

        itemTemplate.innerHTML = html;

        document.getElementById('loading-template').style.display = "none";
        itemTemplate.style.display = "block";
    }

    function generateForm(template) {
        let form = "<form id=template-form>";

        const optionKeys = Object.keys(template.options);
        console.log(optionKeys);
        optionKeys.forEach((key) => {
            const templateOption = template.options[key];
            form += "<div>";
            form += generateInput(templateOption);
            form += "</div>";
        });

        form += "</form>";

        return form;
    }

    function generateInput(templateOption) {
        switch (templateOption.type) {
            case "text": {
                return `
                <label for="template-form-${templateOption.parameter}">${templateOption.description}</label>
                <input type="text" id="template-form-${templateOption.parameter}" name="${templateOption.parameter}"/>`;
            }
            case "select": {
                let select = `
                <label for="template-form-${templateOption.parameter}">${templateOption.description}</label>
                <select id="template-form-${templateOption.parameter}" name="${templateOption.parameter}">`;
                templateOption.selectOptions.forEach((opt) => {
                    select += `<option value="${opt.key}" ${opt.key === templateOption.defaultValue ? "selected": ""}>${opt.description}</option>`
                });
                select += `</select>`;
                return select;
            }
            default: {
                console.log(`input type ${templateOption.type} was not handled`);
                return "";
            }
        }
    }

    init();
</script>

</html>